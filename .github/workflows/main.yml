name: Import Dialogflow CX Agent

on: [workflow_dispatch]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  LOCATION: global
  NEW_AGENT_NAME: "NewAgentName"
  AGENT_JSON: "./agent.json"

jobs:
  import_agent:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Update gcloud SDK
      run: |
        echo "ðŸ”¹ Current gcloud version:"
        gcloud --version
        echo "ðŸ”¹ Updating gcloud..."
        gcloud components update --quiet || true

    - name: Import Dialogflow CX agent
      run: |
        echo "ðŸ”¹ Checking if agent '$NEW_AGENT_NAME' exists..."
        AGENT_ID=$(gcloud dialogflow cx agents list \
          --project=$GCP_PROJECT_ID \
          --location=$LOCATION \
          --filter="displayName=$NEW_AGENT_NAME" \
          --format="value(name)")

        if [ -z "$AGENT_ID" ]; then
          echo "âš¡ Agent not found. Creating new agent..."
          gcloud dialogflow cx agents create \
            --display-name="$NEW_AGENT_NAME" \
            --default-language-code="en" \
            --time-zone="America/Los_Angeles" \
            --location=$LOCATION \
            --project=$GCP_PROJECT_ID
          
          AGENT_ID=$(gcloud dialogflow cx agents list \
            --project=$GCP_PROJECT_ID \
            --location=$LOCATION \
            --filter="displayName=$NEW_AGENT_NAME" \
            --format="value(name)")
        else
          echo "âœ… Agent already exists: $AGENT_ID"
        fi

        echo "ðŸ”¹ Restoring agent from $AGENT_JSON..."
        gcloud dialogflow cx agents restore \
          --agent="$AGENT_ID" \
          --agent-content-file="$AGENT_JSON"

        echo "âœ… Import completed successfully!"
