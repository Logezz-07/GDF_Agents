name: Dialogflow CX Agent Import

on:
  workflow_dispatch:   # Manual trigger

jobs:
  import-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Zip agent files into agent.blob
        run: |
          echo "Zipping agent export files into agent.blob..."
          zip -r agent.blob agent.json flows intents webhooks generativeSettings entityTypes

      - name: Verify agent.blob
        run: |
          echo "Checking if agent.blob was created..."
          ls -lh agent.blob
          test -f agent.blob || (echo "‚ùå agent.blob not created"; exit 1)

      - name: Restore Dialogflow CX Agent
        run: |
          echo "Restoring agent to ID: 37446e1d-8af8-46ba-bcac-416f4d573933"
          gcloud dialogflow cx agents restore 37446e1d-8af8-46ba-bcac-416f4d573933 \
            --location=global \
            --agent-content-file=agent.blob \
            --quiet
