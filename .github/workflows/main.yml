name: Import Dialogflow Agent

on: [workflow_dispatch]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  import_agent:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Install Dialogflow CX gcloud component
      run: gcloud components install dialogflow-cx --quiet

    - name: Import Dialogflow CX agent
      run: |
        LOCATION=global
        NEW_AGENT_NAME="NewAgentName"
        AGENT_JSON="./agent.json"

        echo "ðŸ”¹ Creating new Dialogflow CX agent..."
        gcloud dialogflow cx agents create \
          --display-name="$NEW_AGENT_NAME" \
          --default-language-code="en" \
          --time-zone="America/Los_Angeles" \
          --location="$LOCATION" \
          --project=$GCP_PROJECT_ID

        echo "ðŸ”¹ Fetching agent ID..."
        NEW_AGENT_ID=$(gcloud dialogflow cx agents list \
          --project=$GCP_PROJECT_ID \
          --location=$LOCATION \
          --filter="displayName=$NEW_AGENT_NAME" \
          --format="value(name)")

        echo "âœ… Agent created: $NEW_AGENT_ID"

        echo "ðŸ”¹ Restoring agent from $AGENT_JSON..."
        gcloud dialogflow cx agents restore \
          --agent="$NEW_AGENT_ID" \
          --agent-content-file="$AGENT_JSON"

        echo "âœ… Import completed."
