name: Create Dialogflow CX Agent

on: [workflow_dispatch]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: global   # or set to e.g. us-central1
  AGENT_JSON: ./agent.json

jobs:
  create_agent:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Get Access Token
      id: gcp-token
      run: |
        TOKEN=$(gcloud auth print-access-token)
        echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

    - name: Create Dialogflow CX Agent
      run: |
        echo "ðŸ”¹ Creating agent from $AGENT_JSON..."
        curl -X POST \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d @"$AGENT_JSON" \
          "https://dialogflow.googleapis.com/v3/projects/$GCP_PROJECT_ID/locations/$GCP_REGION/agents"
