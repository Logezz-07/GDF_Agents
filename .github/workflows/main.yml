name: Restore Dialogflow CX Agent

on:
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_LOCATION: ${{ secrets.GCP_LOCATION }}
  DFCX_AGENT_ID: ${{ secrets.DFCX_AGENT_ID }}

jobs:
  restore_agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          version: latest

      - name: Install alpha components (non-interactive)
        run: |
          gcloud components install alpha --quiet

      - name: Zip agent folder
        run: |
          zip -r agent.zip .github entityTypes flows generativeSettings intents webhooks agent.json

      - name: Restore Dialogflow CX agent
        run: |
          gcloud alpha dialogflow agent restore \
            --agent=projects/${{ env.GCP_PROJECT_ID }}/locations/${{ env.GCP_LOCATION }}/agents/${{ env.DFCX_AGENT_ID }} \
            --source=agent.zip \
            --quiet
