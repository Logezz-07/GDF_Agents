name: Deploy Dialogflow CX Agent

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Zip agent files
        run: zip -r agent.zip agent.json flows intents entityTypes webhooks generativeSettings || true

      - name: Restore agent into Dialogflow CX
        run: |
          gcloud alpha dialogflow agents restore \
            --agent=projects/${{ secrets.GCP_PROJECT_ID }}/locations/${{ secrets.GCP_LOCATION }}/agents/${{ secrets.DFCX_AGENT_ID }} \
            --source=agent.zip
